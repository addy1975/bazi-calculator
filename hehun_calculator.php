<?php
/**
 * 神煞分析計算引擎 (正式版)
 * 版本: 1.1 (基於成功驗證的版本)
 * 說明: 採用程序式結構，提供合併後的神煞分析。
 */

if (!function_exists('getShenshaReport')) {
    
    function getMutualCompareRules() {
        return array('子' => array('胞胎相衝' => array('卯', '酉')), '丑' => array('胞胎相衝' => array('辰', '戌')), '寅' => array('胞胎相衝' => array('巳', '亥')), '卯' => array('胞胎相衝' => array('午', '子')), '辰' => array('胞胎相衝' => array('未', '丑')), '巳' => array('胞胎相衝' => array('申', '寅')), '午' => array('胞胎相衝' => array('卯', '酉')), '未' => array('胞胎相衝' => array('辰', '戌')), '申' => array('胞胎相衝' => array('巳', '亥')), '酉' => array('胞胎相衝' => array('午', '子')), '戌' => array('胞胎相衝' => array('未', '丑')), '亥' => array('胞胎相衝' => array('申', '寅')));
    }
    function getYearZhiMonthZhiRules() {
        return array( '子' => array('孤神' => array('寅'), '寡宿' => array('戌'), '男骨膸破' => array('卯'), '女骨膸破' => array('未'), '男鐵掃箒' => array('寅'), '女鐵掃箒' => array('丑'), '六害' => array('未'), '男金星' => array('巳'), '女歲星' => array('卯'), '飛天狼籍' => array('卯', '辰'), '狼籍' => array('午'), '大敗' => array('巳'), '八敗' => array('未')), '丑' => array('孤神' => array('寅'), '寡宿' => array('戌'), '男骨膸破' => array('辰'), '女骨膸破' => array('巳'), '男鐵掃箒' => array('未'), '女鐵掃箒' => array('戌'), '六害' => array('午'), '男金星' => array('午'), '女歲星' => array('寅'), '飛天狼籍' => array('寅'), '狼籍' => array('申'), '大敗' => array('酉'), '八敗' => array('申', '戌')), '寅' => array('孤神' => array('巳'), '寡宿' => array('丑'), '男骨膸破' => array('亥'), '女骨膸破' => array('辰'), '男鐵掃箒' => array('巳'), '女鐵掃箒' => array('申'), '六害' => array('巳'), '男金星' => array('未'), '女歲星' => array('丑'), '飛天狼籍' => array('午', '未'), '狼籍' => array('子'), '大敗' => array('亥'), '八敗' => array('丑')), '卯' => array('孤神' => array('巳'), '寡宿' => array('丑'), '男骨膸破' => array('午'), '女骨膸破' => array('寅'), '男鐵掃箒' => array('卯'), '女鐵掃箒' => array('酉'), '六害' => array('辰'), '男金星' => array('申'), '女歲星' => array('子'), '飛天狼籍' => array('午', '未'), '狼籍' => array('子'), '大敗' => array('亥'), '八敗' => array('丑')), '辰' => array('孤神' => array('巳'), '寡宿' => array('丑'), '男骨膸破' => array('丑'), '女骨膸破' => array('未'), '男鐵掃箒' => array('寅'), '女鐵掃箒' => array('丑'), '六害' => array('卯'), '男金星' => array('酉'), '女歲星' => array('亥'), '飛天狼籍' => array('卯', '辰'), '狼籍' => array('午'), '大敗' => array('巳'), '八敗' => array('未')), '巳' => array('孤神' => array('申'), '寡宿' => array('辰'), '男骨膸破' => array('寅'), '女骨膸破' => array('巳'), '男鐵掃箒' => array('未'), '女鐵掃箒' => array('戌'), '六害' => array('寅'), '男金星' => array('戌'), '女歲星' => array('戌'), '飛天狼籍' => array('卯', '辰'), '狼籍' => array('午'), '大敗' => array('巳'), '八敗' => array('未')), '午' => array('孤神' => array('申'), '寡宿' => array('辰'), '男骨膸破' => array('酉'), '女骨膸破' => array('辰'), '男鐵掃箒' => array('巳'), '女鐵掃箒' => array('申'), '六害' => array('丑'), '男金星' => array('亥'), '女歲星' => array('酉'), '飛天狼籍' => array('午', '未'), '狼籍' => array('子'), '大敗' => array('亥'), '八敗' => array('丑')), '未' => array('孤神' => array('申'), '寡宿' => array('辰'), '男骨膸破' => array('戌'), '女骨膸破' => array('寅'), '男鐵掃箒' => array('卯'), '女鐵掃箒' => array('酉'), '六害' => array('子'), '男金星' => array('子'), '女歲星' => array('申'), '飛天狼籍' => array('子'), '狼籍' => array('子'), '大敗' => array('卯'), '八敗' => array('寅', '辰')), '申' => array('孤神' => array('亥'), '寡宿' => array('未'), '男骨膸破' => array('巳'), '女骨膸破' => array('未'), '男鐵掃箒' => array('寅'), '女鐵掃箒' => array('丑'), '六害' => array('亥'), '男金星' => array('丑'), '女歲星' => array('未'), '飛天狼籍' => array('寅'), '狼籍' => array('申', '酉'), '大敗' => array('申'), '八敗' => array('戌')), '酉' => array('孤神' => array('亥'), '寡宿' => array('未'), '男骨膸破' => array('子'), '女骨膸破' => array('巳'), '男鐵掃箒' => array('未'), '女鐵掃箒' => array('戌'), '六害' => array('戌'), '男金星' => array('寅'), '女歲星' => array('午'), '飛天狼籍' => array('寅'), '狼籍' => array('申', '酉'), '大敗' => array('申'), '八敗' => array('戌')), '戌' => array('孤神' => array('亥'), '寡宿' => array('未'), '男骨膸破' => array('未'), '女骨膸破' => array('辰'), '男鐵掃箒' => array('巳'), '女鐵掃箒' => array('申'), '六害' => array('酉'), '男金星' => array('卯'), '女歲星' => array('巳'), '飛天狼籍' => array('子'), '狼籍' => array('子'), '大敗' => array('卯'), '八敗' => array('寅', '辰')), '亥' => array('孤神' => array('寅'), '寡宿' => array('戌'), '男骨膸破' => array('申'), '女骨膸破' => array('寅'), '男鐵掃箒' => array('卯'), '女鐵掃箒' => array('酉'), '六害' => array('申'), '男金星' => array('辰'), '女歲星' => array('辰'), '飛天狼籍' => array('子'), '狼籍' => array('子'), '大敗' => array('卯'), '八敗' => array('寅', '辰')));
    }
    function getFemaleDayGanRules() {
        return array( '甲' => array('益財' => array('辰', '巳', '午', '未', '申', '酉'), '退財' => array('戌', '亥', '子', '丑', '寅', '卯'), '望门寡' => array('寅'), '夫多厄' => array('子', '丑')), '乙' => array('益財' => array('辰', '巳', '午', '未', '申', '酉'), '退財' => array('戌', '亥', '子', '丑', '寅', '卯'), '望门寡' => array('寅'), '夫多厄' => array('子', '丑')), '丙' => array('益財' => array('未', '申', '酉', '戌', '亥', '子'), '退財' => array('丑', '寅', '卯', '辰', '巳', '午'), '望门寡' => array('巳'), '夫多厄' => array('卯', '辰')), '丁' => array('益財' => array('未', '申', '酉', '戌', '亥', '子'), '退財' => array('丑', '寅', '卯', '辰', '巳', '午'), '望门寡' => array('巳'), '夫多厄' => array('卯', '辰')), '戊' => array('益財' => array('亥', '子', '丑', '寅', '卯', '辰'), '退財' => array('巳', '午', '未', '申', '酉', '戌'), '望门寡' => array('申'), '夫多厄' => array('午', '未')), '己' => array('益財' => array('亥', '子', '丑', '寅', '卯', '辰'), '退財' => array('巳', '午', '未', '申', '酉', '戌'), '望门寡' => array('申'), '夫多厄' => array('午', '未')), '庚' => array('益財' => array('丑', '寅', '卯', '辰', '巳', '午'), '退財' => array('未', '申', '酉', '戌', '亥', '子'), '望门寡' => array('亥'), '夫多厄' => array('酉', '戌')), '辛' => array('益財' => array('丑', '寅', '卯', '辰', '巳', '午'), '退財' => array('未', '申', '酉', '戌', '亥', '子'), '望门寡' => array('亥'), '夫多厄' => array('酉', '戌')), '壬' => array('益財' => array('申', '酉', '戌', '亥', '子', '丑'), '退財' => array('寅', '卯', '辰', '巳', '午', '未'), '望门寡' => array('巳'), '夫多厄' => array('卯', '辰')), '癸' => array('益財' => array('申', '酉', '戌', '亥', '子', '丑'), '退財' => array('寅', '卯', '辰', '巳', '午', '未'), '望门寡' => array('巳'), '夫多厄' => array('卯', '辰')));
    }
    function getMaleDayGanRules() {
        return array( '甲' => array('益財' => array('申', '酉', '戌', '亥', '子', '丑'), '退財' => array('寅', '卯', '辰', '巳', '午', '未'), '望门鰥' => array('巳'), '妻多厄' => array('卯', '辰')), '乙' => array('益財' => array('申', '酉', '戌', '亥', '子', '丑'), '退財' => array('寅', '卯', '辰', '巳', '午', '未'), '望门鰥' => array('巳'), '妻多厄' => array('卯', '辰')), '丙' => array('益財' => array('巳', '午', '未', '申', '酉', '戌'), '退財' => array('亥', '子', '丑', '寅', '卯', '辰'), '望门鰥' => array('寅'), '妻多厄' => array('子', '丑')), '丁' => array('益財' => array('巳', '午', '未', '申', '酉', '戌'), '退財' => array('亥', '子', '丑', '寅', '卯', '辰'), '望门鰥' => array('寅'), '妻多厄' => array('子', '丑')), '戊' => array('益財' => array('午', '未', '申', '酉', '戌', '亥'), '退財' => array('子', '丑', '寅', '卯', '辰', '巳'), '望门鰥' => array('巳'), '妻多厄' => array('卯', '辰')), '己' => array('益財' => array('午', '未', '申', '酉', '戌', '亥'), '退財' => array('子', '丑', '寅', '卯', '辰', '巳'), '望门鰥' => array('巳'), '妻多厄' => array('卯', '辰')), '庚' => array('益財' => array('未', '申', '酉', '戌', '亥', '子'), '退財' => array('丑', '寅', '卯', '辰', '巳', '午'), '望门鰥' => array('申'), '妻多厄' => array('午', '未')), '辛' => array('益財' => array('未', '申', '酉', '戌', '亥', '子'), '退財' => array('丑', '寅', '卯', '辰', '巳', '午'), '望门鰥' => array('申'), '妻多厄' => array('午', '未')), '壬' => array('益財' => array('寅', '卯', '辰', '巳', '午', '未'), '退財' => array('申', '酉', '戌', '亥', '子', '丑'), '望门鰥' => array('亥'), '妻多厄' => array('酉', '戌')), '癸' => array('益財' => array('寅', '卯', '辰', '巳', '午', '未'), '退財' => array('申', '酉', '戌', '亥', '子', '丑'), '望门鰥' => array('亥'), '妻多厄' => array('酉', '戌')));
    }
    function getCommonDayGanRules() {
        return array( '甲' => array('向祿' => array('卯', '辰', '戌', '丑'), '祿庫' => array('未', '申', '戌'), '向財' => array('丑'), '財庫' => array('辰')), '乙' => array('向祿' => array('卯', '辰', '戌', '丑'), '祿庫' => array('未', '申', '戌'), '向財' => array('丑'), '財庫' => array('辰')), '丙' => array('向祿' => array('寅', '辰', '巳', '午', '丑'), '祿庫' => array('戌', '辰', '巳', '未'), '向財' => array('申', '酉'), '財庫' => array('丑')), '丁' => array('向祿' => array('寅', '辰', '巳', '午', '丑'), '祿庫' => array('戌', '辰', '巳', '未'), '向財' => array('申', '酉'), '財庫' => array('丑')), '戊' => array('向祿' => array('未', '申', '戌', '亥', '子'), '祿庫' => array('辰', '未', '申', '戌'), '向財' => array('丑'), '財庫' => array('辰')), '己' => array('向祿' => array('未', '申', '戌', '亥', '子'), '祿庫' => array('辰', '未', '申', '戌'), '向財' => array('丑'), '財庫' => array('辰')), '庚' => array('向祿' => array('辰', '未', '酉', '亥', '丑'), '祿庫' => array('寅', '卯', '戌', '子'), '向財' => array('子', '丑'), '財庫' => array('未')), '辛' => array('向祿' => array('辰', '未', '酉', '亥', '丑'), '祿庫' => array('寅', '卯', '戌', '子'), '向財' => array('子', '丑'), '財庫' => array('未')), '壬' => array('向祿' => array('未', '申', '戌', '亥', '子'), '祿庫' => array('寅', '巳', '午', '辰'), '向財' => array('丑'), '財庫' => array('戌')), '癸' => array('向祿' => array('未', '申', '戌', '亥', '子'), '祿庫' => array('寅', '巳', '午', '辰'), '向財' => array('丑'), '財庫' => array('戌')));
    }

    function findShensha_ManToWoman($manBazi, $womanBazi) { $rules = getMutualCompareRules(); $manYearZhi = $manBazi['year_zhi']; $womanMonthZhi = $womanBazi['month_zhi']; $foundShensha = array(); if (isset($rules[$manYearZhi])) { foreach ($rules[$manYearZhi] as $shenshaName => $triggerZhiArray) { if (in_array($womanMonthZhi, $triggerZhiArray)) { $foundShensha[] = $shenshaName; } } } return $foundShensha;}
    function findShensha_WomanToMan($womanBazi, $manBazi) { $rules = getMutualCompareRules(); $womanYearZhi = $womanBazi['year_zhi']; $manMonthZhi = $manBazi['month_zhi']; $foundShensha = array(); if (isset($rules[$womanYearZhi])) { foreach ($rules[$womanYearZhi] as $shenshaName => $triggerZhiArray) { if (in_array($manMonthZhi, $triggerZhiArray)) { $foundShensha[] = $shenshaName; } } } return $foundShensha;}
    function findShenshaByYearAndMonthZhi($baziInfo) { $rules = getYearZhiMonthZhiRules(); $gender = $baziInfo['gender']; $yearZhi = $baziInfo['year_zhi']; $monthZhi = $baziInfo['month_zhi']; $foundShensha = array(); if (isset($rules[$yearZhi])) { foreach ($rules[$yearZhi] as $shenshaName => $triggerZhiArray) { if (is_array($triggerZhiArray) && in_array($monthZhi, $triggerZhiArray)) { $isGenderMatch = true; if (strpos($shenshaName, '男') === 0) { if ($gender !== 'man') $isGenderMatch = false; } elseif (strpos($shenshaName, '女') === 0) { if ($gender !== 'woman') $isGenderMatch = false; } if ($isGenderMatch) { $foundShensha[] = $shenshaName; } } } } return array_unique($foundShensha);}
    function findShensha_FemaleDayGan($womanBazi) { $rules = getFemaleDayGanRules(); $dayGan = $womanBazi['day_gan']; $monthZhi = $womanBazi['month_zhi']; $foundShensha = array(); if (isset($rules[$dayGan])) { foreach ($rules[$dayGan] as $shenshaName => $triggerZhiArray) { if (is_array($triggerZhiArray) && in_array($monthZhi, $triggerZhiArray)) { $foundShensha[] = $shenshaName; } } } return array_unique($foundShensha);}
    function findShensha_MaleDayGan($manBazi) { $rules = getMaleDayGanRules(); $dayGan = $manBazi['day_gan']; $monthZhi = $manBazi['month_zhi']; $foundShensha = array(); if (isset($rules[$dayGan])) { foreach ($rules[$dayGan] as $shenshaName => $triggerZhiArray) { if (is_array($triggerZhiArray) && in_array($monthZhi, $triggerZhiArray)) { $foundShensha[] = $shenshaName; } } } return array_unique($foundShensha);}
    function findShensha_CommonDayGan($baziInfo) { $rules = getCommonDayGanRules(); $dayGan = $baziInfo['day_gan']; $monthZhi = $baziInfo['month_zhi']; $foundShensha = array(); if (isset($rules[$dayGan])) { foreach ($rules[$dayGan] as $shenshaName => $triggerZhiArray) { if (is_array($triggerZhiArray) && in_array($monthZhi, $triggerZhiArray)) { $foundShensha[] = $shenshaName; } } } return array_unique($foundShensha);}

    function getShenshaReport(array $manBazi, array $womanBazi): array {
        $manShensha_year_month = findShenshaByYearAndMonthZhi($manBazi);
        $manShensha_day_gan_specific = findShensha_MaleDayGan($manBazi);
        $manShensha_day_gan_common = findShensha_CommonDayGan($manBazi);
        $man_personal_shensha = array_merge($manShensha_year_month, $manShensha_day_gan_specific, $manShensha_day_gan_common);
        
        $womanShensha_year_month = findShenshaByYearAndMonthZhi($womanBazi);
        $womanShensha_day_gan_specific = findShensha_FemaleDayGan($womanBazi);
        $womanShensha_day_gan_common = findShensha_CommonDayGan($womanBazi);
        $woman_personal_shensha = array_merge($womanShensha_year_month, $womanShensha_day_gan_specific, $womanShensha_day_gan_common);

        $manToWomanResult = findShensha_ManToWoman($manBazi, $womanBazi);
        $womanToManResult = findShensha_WomanToMan($womanBazi, $manBazi);

        $final_man_shensha = array_unique(array_merge($man_personal_shensha, $womanToManResult));
        $final_woman_shensha = array_unique(array_merge($woman_personal_shensha, $manToWomanResult));

        return array(
            'personal' => array(
                'man' => $final_man_shensha,
                'woman' => $final_woman_shensha
            )
        );
    }
}